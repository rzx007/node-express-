<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>厂站汇总</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <style>
        html,
        body {
            padding: 0px;
            margin: 0px;
        }

        #ifram_wrap {
            position: fixed;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            z-index: 100;
            background-color: rgb(5, 19, 53);
            display: none;
        }

        #ifram_wrap iframe {
            width: 100%;
            height: 100%;
        }

        #close_btn {
            position: absolute;
            top: 16px;
            right: 40px;
            cursor: pointer;
        }
    </style>

    <script src="js/ht.js"></script>
    <script src='js/ht-edgetype.js'></script>
    <script src='js/ht-vector.js'></script>
    <script src="js/ht-form.js"></script>
    <script src="js/jquery-3.4.1.min.js"></script>

    <script>
        columnCount = 6;
        stateMap = {
            0: '#323450',
            1: '#454668',
            2: '#FF6A01',
            3: '#FF2D0D'
        };
        hlxStateMap = {
            0: '#6F7082',
            1: '#76E33E',
            2: '#FF6A01',
            3: '#FF2D0D'
        };

        Date.prototype.format = function (fmt) {
            var o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "h+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            }
            for (var k in o) {
                if (new RegExp("(" + k + ")").test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[
                        k]).length)));
                }
            }
            return fmt;
        };

        function fetchData() {
            basicData = '';
            ht.Default.xhrLoad("datasets/basicData.json", function (text) {
                basicData = text;
            });

            realTimeData = '';
            ht.Default.xhrLoad("datasets/realTimeData.json", function (text) {
                realTimeData = text;
            });
        }

        function createDatas() {
            json = JSON.parse(basicData);
            json.result.forEach(function (data) {
                var node = new ht.Node();
                node.setImage('symbols/enjoy/pv/pv-box.json');
                node.s({
                    'select.color': 'white',
                    '2d.selectable': false
                });
                node.a({
                    deviceName: data.deviceName,
                    capacity: data.capacity + 'KW',
                    raw_capacity: data.capacity
                });
                node.setTag(data.deviceCode);
                graphView.getDataModel().add(node);
            });
        }

        function fillDatas() {
            var hlx_state_0 = hlx_state_1 = hlx_state_2 = hlx_state_3 = 0;
            var zc_state_1 = zc_state_2 = zc_state_3 = 0;

            json = JSON.parse(realTimeData);
            json.result.wtrtDatas.forEach(function (data) {
                var comboxRTDto = data.comboxRTDto;
                var node = graphView.getDataModel().getDataByTag(comboxRTDto.deviceCode);
                if (node) {
                    var hlxState = comboxRTDto.pvDeviceStCode;
                    node.a({
                        hlxState: hlxStateMap[hlxState],
                        discreteRate: comboxRTDto.discreteRate + '%',
                        outputPower: comboxRTDto.outputPower + 'KW',
                        percentage: comboxRTDto.outputPower / node.a('raw_capacity')
                    });

                    for (var i = 0; i < data.strings.length; i++) {
                        var string = data.strings[i];
                        var pvDeviceStCode = string.pvDeviceStCode;
                        node.a('state' + i, stateMap[pvDeviceStCode]);
                        if (pvDeviceStCode === 0) {
                            node.a('branch' + i, '--');
                        } else {
                            node.a('branch' + i, string.dC_A);
                        }

                        if (pvDeviceStCode == 1) {
                            zc_state_1++;
                        } else if (pvDeviceStCode == 2) {
                            zc_state_2++;
                        } else if (pvDeviceStCode == 3) {
                            zc_state_3++;
                        }
                        childNode = new ht.Node();
                        childNode.a({
                            deviceCode: comboxRTDto.deviceCode,
                            branchName: string.branchName,
                            pvDeviceStCode: string.pvDeviceStCode,
                            dc: string.dC_A
                        });
                        childNode.setTag(string.branchName);
                        node.addChild(childNode);
                    }

                    if (hlxState == 0) {
                        hlx_state_0++;
                    } else if (hlxState == 1) {
                        hlx_state_1++;
                    } else if (hlxState == 2) {
                        hlx_state_2++;
                    } else if (hlxState == 3) {
                        hlx_state_3++;
                    }
                }
            });

            var dm = header.getDataModel();
            dm.getDataByTag('sum').a('outputPower', json.result.stationRTData.outputPower);
            dm.getDataByTag('sum').a('rescourceValue', json.result.stationRTData.rescourceValue);
            dm.getDataByTag('sum').a('radiDayGen', json.result.stationRTData.radiDayGen);
            dm.getDataByTag('sum').a('dayGen', json.result.stationRTData.dayGen);
            dm.getDataByTag('sum').a('capacity', '21.00');

            // var date = new Date(Date.parse(json.result.stationRTData.lastRefreshTime));
            dm.getDataByTag('sum').a('lastRefreshTime', '刷新时间: ' + new Date().format('yyyy-MM-dd hh:mm:ss'));

            // dm.getDataByTag('hlx_state_0').s('label', hlx_state_0);
            // dm.getDataByTag('hlx_state_1').s('label', hlx_state_1);
            // dm.getDataByTag('hlx_state_2').s('label', hlx_state_2);
            // dm.getDataByTag('hlx_state_3').s('label', hlx_state_3);
            // dm.getDataByTag('zc_state_1').s('label', zc_state_1);
            // dm.getDataByTag('zc_state_2').s('label', zc_state_2);
            // dm.getDataByTag('zc_state_3').s('label', zc_state_3);
            dm.getDataByTag('hlx_state_1').s('label', '变压器');
            dm.getDataByTag('hlx_state_3').s('label', '断路器');
            dm.getDataByTag('hlx_state_2').s('label', '环网柜');
        }

        function layoutDatas() {
            var w = 420;
            var h = 90;
            var gap = 10;
            var datas = graphView.getDataModel().toDatas(graphView.isVisible, graphView);
            datas.sort(function (d1, d2) {
                return ht.Default.sortFunc(d1.a('deviceName'), d2.a('deviceName'));
            });
            list = [];
            for (var i = 0; i < datas.size(); i++) {
                var row = Math.floor(i / columnCount);
                var column = i - row * columnCount;
                var node = datas.get(i);
                list.push({
                    node: node,
                    p1: node.p(),
                    p2: {
                        x: w / 2 + column * (gap + w),
                        y: h / 2 + row * (gap + h)
                    }
                });
            }
            ht.Default.startAnim({
                duration: 500,
                finishFunc: function () {
                    // graphView.fitContent();
                },
                action: function (v, t) {
                    list.forEach(function (info) {
                        info.node.p(
                            info.p1.x + (info.p2.x - info.p1.x) * v,
                            info.p1.y + (info.p2.y - info.p1.y) * v
                        );
                    });
                }
            });
        }

        function createHeader() {
            header = new ht.graph.GraphView();
            ht.Default.xhrLoad('displays/enjoy/pv/pv-header.json', function (json) {
                header.getDataModel().deserialize(json);
                header.getDataModel().setBackground(undefined);
                createDatas();
                fillDatas();
                layoutDatas();
            });

            header.setInteractors(null);
            var handleClick = function (e) {
                if (!graphView.getView().contains(e.target)) {
                    var data = header.getDataAt(e);
                    header.sm().ss(data);
                }
            };
            document.body.addEventListener('mousedown', handleClick, false);
            document.body.addEventListener('touchstart', handleClick, false);
            header.sm().ms(function (e) {
                var selectedData = header.sm().ld();
                graphView.setVisibleFunc(function (data) {
                    if (!selectedData) {
                        return true;
                    } else if (selectedData.getTag() === 'hlx_state_0') {
                        return data.a('hlxState') == hlxStateMap[0];
                    } else if (selectedData.getTag() === 'hlx_state_1') {
                        return data.a('hlxState') == hlxStateMap[1];
                    } else if (selectedData.getTag() === 'hlx_state_2') {
                        return data.a('hlxState') == hlxStateMap[2];
                    } else if (selectedData.getTag() === 'hlx_state_3') {
                        return data.a('hlxState') == hlxStateMap[3];
                    } else if (selectedData.getTag() === 'zc_state_1') {
                        for (var i = 0; i < 16; i++) {
                            if (data.a('state' + i) === stateMap[1]) {
                                return true;
                            }
                        }
                    } else if (selectedData.getTag() === 'zc_state_2') {
                        for (var i = 0; i < 16; i++) {
                            if (data.a('state' + i) === stateMap[2]) {
                                return true;
                            }
                        }
                    } else if (selectedData.getTag() === 'zc_state_3') {
                        for (var i = 0; i < 16; i++) {
                            if (data.a('state' + i) === stateMap[3]) {
                                return true;
                            }
                        }
                    }
                    return false;
                });
                layoutDatas()
            });
        }

        function createBody() {
            graphView = new ht.graph.GraphView();
            graphView.setInteractors([
                new ht.graph.ScrollBarInteractor(graphView),
                new ht.graph.DefaultInteractor(graphView),
                new ht.graph.TouchInteractor(graphView, {
                    editable: false
                })
            ]);
            var filter = function (data) {
                return true;
            };
            var handleClick = function (e) {
                var data = graphView.getDataAt(e, filter);
                // console.log(e);
                // console.log(data);
                graphView.sm().ss(data);
            };
            graphView.getView().addEventListener('mousedown', handleClick, false);
            graphView.getView().addEventListener('touchstart', handleClick, false);
            graphView.getView().addEventListener('dblclick', function (e) {
                var data = graphView.getDataAt(e, filter);
                if (data) {
                    graphView.fitRect(data.getRect(), true, true);
                }
            }, false);
            graphView.getView().style.background = 'rgb(49,51,79)';
            graphView.scrollZoomIn = function (point) {
                this.setZoom(this._zoom * 1.1, null, point);
            };
            graphView.scrollZoomOut = function (point) {
                this.setZoom(this._zoom / 1.1, null, point);
            };
            graphView.addInteractorListener(eventHandler);
        }

        function createFormPane() {
            formPane = new ht.widget.FormPane();
            formPane.addRow([null, header, null], [0.1, 810, 0.1], 110);
            formPane.addRow([graphView], [0.1], 0.1);
            formPane.setVGap(0)
            formPane.setHGap(0)
            formPane.setPadding(0)
            formPane.addToDOM();
            formPane.getView().style.background = '#292028';
        }

        function init() {
            fetchData();
            setTimeout(function () {
                createBody();
                createHeader();
                createFormPane();
            }, 1000);
        }

        $(document).ready(function () {
            window.setTimeout(function () {
                $('#close_btn').click(function () {
                    $("#ifram_wrap").css({
                        'display': 'none'
                    })
                })
                var lastDiv = $("canvas").parent();
                var pane = lastDiv[lastDiv.length - 1];
                if (pane && pane.tabIndex == '-1') {
                    pane.style.display = "none";
                }
            }, 10);
        });
        // 事件交互
        var eventHandler = function (e) {
            if (e.kind === 'clickData') {
                if (e.data._id > 0) {
                    // $("#iframe").attr({
                    //     src: "../lineQuery/index.html"
                    // })
                    // $("#ifram_wrap").css({
                    //     'display': 'block '
                    // })
                    window.open("../lineQuery/index.html"); 
                    // parent.location.reload()
                }
                // node = e.data;
                // child = node.getDataAt(e);
                // console.log(child + "被单击");
            }
            else if(e.kind === 'doubleClickData'){
                return false
                console.log(e.data + '被双击');
            }
            // else if(e.kind === 'clickBackground'){
            //     console.log('单击背景');
            // }
            // else if(e.kind === 'doubleClickBackground'){
            //     console.log('双击背景');
            // }
            // else if(e.kind === 'beginRectSelect'){
            //     console.log('开始框选图元');
            // }
            // else if(e.kind === 'betweenRectSelect'){
            //     console.log('正在框选图元');
            // }
            // else if(e.kind === 'endRectSelect'){
            //     console.log('结束框选图元');
            // }
            // else if(e.kind === 'beginMove'){
            //     console.log('开始移动图元');
            // }
            // else if(e.kind === 'betweenMove'){
            //     console.log('正在移动图元');
            // }
            // else if(e.kind === 'endMove'){
            //     console.log('结束移动图元');
            // }
            // else if(e.kind === 'beginPan'){
            //     console.log('开始手抓图平移');
            // }
            // else if(e.kind === 'betweenPan'){
            //     console.log('正在手抓图平移');
            // }
            // else if(e.kind === 'endPan'){
            //     console.log('结束手抓图平移');
            // }
            // else if(e.kind === 'beginEditRect'){
            //     console.log('开始编辑图元大小和位置');
            // }
            // else if(e.kind === 'betweenEditRect'){
            //     console.log('正在编辑图元大小和位置');
            // }
            // else if(e.kind === 'endEditRect'){
            //     console.log('结束编辑图元大小和位置');
            // }
            // else if(e.kind === 'beginEditPoint'){
            //     console.log('开始编辑多边形Shape或多点Edge的具体点');
            // }
            // else if(e.kind === 'betweenEditPoint'){
            //     console.log('正在编辑多边形Shape或多点Edge的具体点');
            // }
            // else if(e.kind === 'endEditPoint'){
            //     console.log('结束编辑多边形Shape或多点Edge的具体点');
            // }
            // else if(e.kind === 'beginEditRotation'){
            //     console.log('开始旋转图元');
            // }
            // else if(e.kind === 'betweenEditRotation'){
            //     console.log('正在旋转图元');
            // }
            // else if(e.kind === 'endEditRotation'){
            //     console.log('结束旋转图元');
            // }
            // else if(e.kind === 'moveLeft'){
            //     console.log('左方向键左移图元一个像素');
            // }
            // else if(e.kind === 'moveRight'){
            //     console.log('右方向键右移图元一个像素');
            // }
            // else if(e.kind === 'moveUp'){
            //     console.log('上方向键上移图元一个像素');
            // }
            // else if(e.kind === 'moveDown'){
            //     console.log('下方向键下移图元一个像素');
            // }
            // else if(e.kind === 'toggleNote'){
            //     console.log('切换note标注的展开合并');
            // }
            // else if(e.kind === 'toggleNote2'){
            //     console.log('切换note2标注的展开合并');
            // }
            // else if(e.kind === 'beginEditPoints'){
            //     console.log('开始进入曲线的点编辑状态');
            // }
            // else if(e.kind === 'endEditPoints'){
            //     console.log('结束曲线的点编辑状态');
            // }
            // else if(e.kind === 'hover'){
            //     console.log('鼠标停留');
            // }
            // else if(e.kind === 'onClick'){
            //     console.log('单击图元');
            // }
            // else if(e.kind === 'onDoubleClick'){
            //     console.log('双击图元');
            // }
            // else if(e.kind === 'onContextMenu'){
            //     console.log('右击图元');
            // }
            // else if(e.kind === 'onDown'){
            //     console.log('在图元处按下');
            // }
            // else if(e.kind === 'onUp'){
            //     console.log('在图元处放开');
            // }
            // else if(e.kind === 'onMove'){
            //     console.log('鼠标在图元上移动');
            // }
            // else if(e.kind === 'onEnter'){
            //     console.log('鼠标进入图元');
            // }
            // else if(e.kind === 'onHover'){
            //     console.log('鼠标在图元上悬停');
            // }
            // else if(e.kind === 'onLeave'){
            //     console.log('鼠标离开图元');
            // }
            // else if(e.kind === 'onBeginDrag'){
            //     console.log('图元开始拖拽');
            // }
            // else if(e.kind === 'onDrag'){
            //     console.log('图元拖拽');
            // }
            // else if(e.kind === 'onEndDrag'){
            //     console.log('图元结束拖拽');
            // }
            // else if(e.kind === 'onScroll'){
            //     console.log('鼠标图元上滚动');
            // }
        };
    </script>

<body onload="init()">
    <div id="ifram_wrap">
        <div id="close_btn"><img width="40px;" src="../assets/img/关闭.png" alt=""></div>
        <iframe id="iframe" frameborder="0"></iframe>
    </div>

</body>

</html>